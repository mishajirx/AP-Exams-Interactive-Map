import csv
from json import dumps, loads
from pprint import pprint
from openpyxl import load_workbook
from config import SubjectToID

common_id = 0

# SY  ;DIST_CODE   ;DIST_NAME        ;ORG_CODE     ;ORG_NAME     ;ORG_TYPE	SUBJ_CAT	SUBJ	STUGRP	TESTS_TAKEN	SCORE_1	SCORE_2	SCORE_3	SCORE_4	SCORE_5	PCT_1_2	PCT_3_5
# "id";"subject_id";"hierarchy_level";"School Code";
# "Tests Taken";"Score=1";"Score=2";"Score=3";"Score=4";"Score=5";"% Score 1-2";"% Score 3-5";
# "Year"

org_id_list = [8850605,
               1970505,
               7000505,
               3310515,
               960505,
               720505,
               1720505,
               8250605,
               940505,
               2010505,
               4960305,
               8150605,
               4910550,
               7400505,
               200505,
               6450505,
               7120515,
               8210605,
               950505,
               2610505,
               360505,
               7630505,
               8790605,
               2920505,
               3100505,
               8550605,
               6650505,
               9100705,
               2650505,
               6500505,
               6600505,
               1820505,
               2390515,
               520405,
               2930505,
               160505,
               2390505,
               4830305,
               2180505,
               2120505,
               6250505,
               8720605,
               8100605,
               7600505,
               3230505,
               830505,
               1670505,
               6220505,
               3160505,
               820505,
               3040505,
               6580505,
               770505,
               990505,
               1590505,
               880505,
               4460550,
               870505,
               7660505,
               2310505,
               6900505,
               7800505,
               50505,
               2770515,
               440505,
               250505,
               1010505,
               8780605,
               35160305,
               2140505,
               35140305,
               2810475,
               7650505,
               2810510,
               1710505,
               6800505,
               2660505,
               2810320,
               1910505,
               2810530,
               10505,
               2810620,
               3250505,
               3320505,
               4410505,
               2510505,
               1380505,
               2850505,
               180510,
               1220505,
               2810500,
               2810205,
               8760605,
               35020405,
               2260505,
               3070505,
               1850505,
               2900510,
               35010505,
               8730605,
               1330505,
               610505,
               1770505,
               4880550,
               2270505,
               7100510,
               1610505,
               7700505,
               7700605,
               2190505,
               2440505,
               500505,
               8050605,
               9150705,
               39020900,
               1870505,
               610510,
               8060605,
               1750505,
               8600605,
               2200505,
               2640505,
               4990305,
               1370505,
               1860505,
               400505,
               1360505,
               170505,
               1100505,
               1390505,
               3360505,
               1310505,
               2780505,
               3350505,
               650505,
               6550505,
               4790505,
               3480520,
               4120530,
               730505,
               6180505,
               7780505,
               3090505,
               7670505,
               6720505,
               1510505,
               2430505,
               3480350,
               140505,
               860505,
               3480515,
               4160305,
               3480285,
               350542,
               350558,
               3210505,
               1110505,
               350541,
               240505,
               1890505,
               3480512,
               1980505,
               8290605,
               4680505,
               3480605,
               2430510,
               2150505,
               1000515,
               350507,
               350657,
               1990505,
               4380505,
               4440205,
               4280305,
               350426,
               2710505,
               3170505,
               3480503,
               350581,
               6830505,
               1420505,
               350535,
               1500505,
               350549,
               350525,
               4840505,
               2070510,
               350545,
               4520505,
               4490305,
               4370505,
               2100505,
               7300505,
               350074,
               350540,
               350575,
               4060705,
               350537,
               350522,
               460505,
               4300305,
               350755,
               3300505,
               1170505,
               3150505,
               2070505,
               1700505,
               350546,
               4110305,
               350690,
               350505,
               1520505,
               350750,
               350655,
               4690505,
               7750505,
               350560,
               3220505,
               4870550,
               4360305,
               8010605,
               3140505,
               6200505,
               490506,
               1270505,
               350515,
               3460505,
               350530,
               6050505,
               4100205,
               2740505,
               1410505,
               570505,
               260505,
               3080505,
               6950505,
               570705,
               7530505,
               4940205,
               640505,
               2480505,
               930505,
               100505,
               1740505,
               1650505,
               1760505,
               1550505,
               8300605,
               2360505,
               6400505,
               7250505,
               3440505,
               1780505,
               1630605,
               2360510,
               2620505,
               1630505,
               35060505,
               4290010,
               2910505,
               2840505,
               6350505,
               1630510,
               6000505,
               3470505,
               6700505,
               1680505,
               8530605,
               3050505,
               480505,
               1250505,
               4850485,
               2580505,
               230505,
               1530505,
               1530605,
               2460505,
               1640505,
               1580505,
               2290510,
               3420505,
               4780505,
               310505,
               8320605,
               300505,
               6160505,
               8520605,
               7550505,
               1030505,
               3260505,
               2170505,
               6980510,
               710505,
               6150505,
               6740505,
               7200505,
               39010900,
               8170505,
               6030505,
               4130505,
               1140505,
               8180605,
               1620505,
               2950505,
               4740505,
               6100505,
               6730505,
               7170505,
               1070505,
               4140305,
               970505,
               560505,
               7050505,
               6750505,
               35030205,
               8280605,
               1600505,
               2520510,
               90505,
               4350305,
               8510605,
               7350505,
               7500505,
               2090505,
               790505,
               7150505,
               1440505,
               3010505,
               3430515,
               2110505,
               1490515,
               1050505,
               1810505,
               7730505,
               7450505,
               1280505,
               2040505,
               70505,
               ]

input_file = f"Facts/ap_performance_whole.csv"
output_file = f"FactsUpd/ap_performance_whole.csv"

csv_file = open(input_file)
reader = csv.reader(csv_file, delimiter=",")
print(next(reader))

result_file = open(output_file, "w", newline='')
writer = csv.writer(result_file, delimiter=';', quotechar='"')

record_id = 0

fields = ["id", "subject_id", "hierarchy_level", "School Code", "Tests Taken", "Score=1", "Score=2", "Score=3",
          "Score=4", "Score=5", "% Score 1-2", "% Score 3-5", "Year"]

writer.writerow(fields)

for row in reader:
    year, d_id, d_name, org_id, org_name, org_type, subj_cat, subj, studgrp, *stats = row
    # "Tests Taken";"Score=1";"Score=2";"Score=3";"Score=4";"Score=5";"% Score 1-2";"% Score 3-5";
    # len(_) = 8
    if studgrp != "All Students":
        continue
    if org_type != "School":
        continue
    if int(org_id) not in org_id_list:
        if year == '2024':
            print(org_name, org_id)
        continue

    # recalculate percentages
    if stats[1]:
        stats[6] = str(100 * round((float(stats[1]) + float(stats[2])) / float(stats[0]), 3))
        stats[7] = str(100 * round((float(stats[3]) + float(stats[4]) + float(stats[5])) / float(stats[0]), 3))
    else:
        stats = [stats[0]] + [0] * 7

    subj_id, subj_hierarchy = SubjectToID[subj]

    record = (record_id, subj_id, subj_hierarchy, org_id, *stats, year)
    writer.writerow(record)
    # print(record)
    record_id += 1

csv_file.close()
result_file.close()
